# 데이터베이스 설계

## ERD (Entity Relationship Diagram)

```mermaid
erDiagram
    USERS ||--o{ BOARDS : owns
    USERS ||--o{ POSTS : writes
    USERS ||--o{ SESSIONS : has
    BOARDS ||--o{ POSTS : contains
    
    USERS {
        int id PK
        string fullname
        string email UK
        string hashed_password
        datetime created_at
    }
    
    SESSIONS {
        uuid id PK
        int user_id FK
        string device_name
        string ip_address
        text user_agent
        string refresh_token_hash UK
        datetime created_at
        datetime last_seen_at
        datetime expires_at
        datetime revoked_at
        string revocation_reason
    }
    
    BOARDS {
        int id PK
        string name UK
        boolean public
        int owner_id FK
        int post_count
        datetime created_at
    }
    
    POSTS {
        int id PK
        string title
        text content
        int board_id FK
        int author_id FK
        datetime created_at
        datetime updated_at
    }
```

## 테이블 상세 설계

### users 테이블
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | INTEGER | PK, AUTO_INCREMENT | 사용자 고유 ID |
| fullname | VARCHAR(100) | NOT NULL | 사용자 이름 |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 로그인용 이메일 |
| hashed_password | VARCHAR(255) | NOT NULL | 암호화된 비밀번호 |
| created_at | TIMESTAMP | DEFAULT NOW() | 계정 생성일 |

### sessions 테이블
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PK | 세션 고유 ID |
| user_id | INTEGER | FK(users.id), NOT NULL | 사용자 ID |
| device_name | VARCHAR(255) | | 기기명 (자동 파싱) |
| ip_address | VARCHAR(45) | | IP 주소 (IPv6 지원) |
| user_agent | TEXT | | User-Agent 문자열 |
| refresh_token_hash | VARCHAR(255) | UNIQUE, NOT NULL | RT 해시값 |
| created_at | TIMESTAMP | DEFAULT NOW() | 세션 생성일 |
| last_seen_at | TIMESTAMP | DEFAULT NOW() | 마지막 활동일 |
| expires_at | TIMESTAMP | NOT NULL | RT 만료일 |
| revoked_at | TIMESTAMP | NULL | 로그아웃 일시 (NULL=활성) |
| revocation_reason | VARCHAR(100) | | 로그아웃 사유 |

### boards 테이블
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | INTEGER | PK, AUTO_INCREMENT | 게시판 고유 ID |
| name | VARCHAR(100) | UNIQUE, NOT NULL | 게시판 이름 |
| public | BOOLEAN | DEFAULT TRUE | 공개 여부 |
| owner_id | INTEGER | FK(users.id), NOT NULL | 소유자 ID |
| post_count | INTEGER | DEFAULT 0 | 게시글 수 캐시 |
| created_at | TIMESTAMP | DEFAULT NOW() | 게시판 생성일 |

### posts 테이블
| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | INTEGER | PK, AUTO_INCREMENT | 게시글 고유 ID |
| title | VARCHAR(200) | NOT NULL | 게시글 제목 |
| content | TEXT | NOT NULL | 게시글 내용 |
| board_id | INTEGER | FK(boards.id), NOT NULL | 소속 게시판 ID |
| author_id | INTEGER | FK(users.id), NOT NULL | 작성자 ID |
| created_at | TIMESTAMP | DEFAULT NOW() | 게시글 생성일 |
| updated_at | TIMESTAMP | ON UPDATE NOW() | 게시글 수정일 |

## 인덱스 설계

### 성능 최적화를 위한 인덱스
```sql
-- 세션 관리용 인덱스
CREATE INDEX idx_sessions_user_active ON sessions (user_id) 
WHERE revoked_at IS NULL;

CREATE INDEX idx_sessions_expires ON sessions (expires_at);

CREATE UNIQUE INDEX idx_sessions_refresh_token ON sessions (refresh_token_hash);

-- 공개 게시판 정렬용 (UNION ALL 최적화)
CREATE INDEX idx_boards_public_rank ON boards (public, post_count DESC, id)
WHERE public = true;

-- 내 게시판 정렬용 (UNION ALL 최적화)  
CREATE INDEX idx_boards_owner_rank ON boards (owner_id, post_count DESC, id);

-- 게시글 목록 조회 (board별 시간 내림차순)
CREATE INDEX idx_posts_board_created ON posts (board_id, created_at DESC, id DESC);

-- 권한 체크용 인덱스
CREATE INDEX idx_posts_author ON posts (author_id);

-- 고유 제약조건
CREATE UNIQUE INDEX idx_users_email ON users (email);
CREATE UNIQUE INDEX idx_boards_name ON boards (name);
```

## 데이터 무결성

### 외래키 제약조건
- `sessions.user_id` → `users.id` (CASCADE DELETE)
- `boards.owner_id` → `users.id` (RESTRICT DELETE)
- `posts.board_id` → `boards.id` (CASCADE DELETE)
- `posts.author_id` → `users.id` (RESTRICT DELETE)

### 비즈니스 규칙
- 게시판 이름은 전역 고유
- 사용자 이메일은 전역 고유
- 게시판 삭제 시 모든 게시글 함께 삭제
- 사용자 삭제 시 소유한 게시판이 있으면 삭제 불가
- 사용자 삭제 시 작성한 게시글이 있으면 삭제 불가

## Redis 데이터 구조

### 게시글 수 증감량 캐시
```
Key: board:post_count
Type: Hash
Fields: 
  - {board_id}: {delta_count}
TTL: 없음 (배치작업으로 정리)
```